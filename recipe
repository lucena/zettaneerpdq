#
# Recipe for Aerohive VM/Disk Creation
#

#
# Create the initial disks and VM
#

# First create a 200GB data disk.
gcutil --project=zettaneerpdq adddisk aerodata01 --zone=us-central1-f --size_gb=200 

# Then create a VM using the CentOS image and also attaches to the data disk
gcutil --project=zettaneerpdq addinstance aerovm01 --zone=us-central1-f --disk=aerodata01 --machine_type=n1-standard-1 --image=centos-6

# Connect to the vm
gcutil --project=zettaneerpdq ssh aerovm01


# Once on the VM, Find the disk: (should be /dev/sdb)
ls -l /dev/disk/by-id/google-*

# create the mount point
sudo mkdir /mnt/aerodata01

# mount the disk and give everyone permissions to it.
sudo /usr/share/google/safe_format_and_mount -m "mkfs.ext4 -F" /dev/sdb /mnt/aerodata01
sudo chmod a+w /mnt/aerodata01

# verify it is there
df -h

# Add some data
echo 'hello as of' `date` > /mnt/aerodata01/hello.txt

# Set it to remount automatically.
echo '/dev/sdb /mnt/aerodata01 ext4 defaults,auto,noatime,noexec 0 0' | sudo tee -a /etc/fstab

# Exit and restart the instance to verify the auto mounting.
gcutil --project=zettaneerpdq resetinstance aerovm01


#
# Image Cloning
#

# Shutdown the VM
sudo shutdown -P now

# Delete the instance so you it will release access to the disks.
gcutil --project=zettaneerpdq deleteinstance aerovm01 --zone=us-central1-f

# Create the image of the boot disk
gcutil --project=zettaneerpdq addimage aerovmimage --source_disk=aerovm01 --zone=us-central1-f

# Create a snapshot of the data disk
gcutil --project=zettaneerpdq addsnapshot aerosnap01 --source_disk=aerodata01

# Recreate the original aerovm01 vm instance with the original disks
gcutil --project=zettaneerpdq addinstance aerovm01 --zone=us-central1-f --disk=aerovm01,boot --disk=aerodata01 --machine_type=n1-standard-1

#
# Creating a new vm instance from the disks
#

# First create the boot disk from the image
gcutil --project=zettaneerpdq adddisk aerovm02 --zone=us-central1-f --source_image=aerovmimage 

# Next create the data disk from the snapshot
gcutil --project=zettaneerpdq adddisk aerodata02 --zone=us-central1-f --source_snapshot=aerosnap01

# Create a new vm instance using the new disks
gcutil --project=zettaneerpdq addinstance aerovm02 --zone=us-central1-f --disk=aerovm02,boot --disk=aerodata02 --machine_type=n1-standard-1


#
# Other useful commands
#

# Unmount it
sudo umount /dev/disk/by-id/google-aerodata01

# Detach it
gcutil --project=zettaneerpdq detachdisk --zone=us-central1-f --device_name=aerodata01 aerovm01

# Reattach it
gcutil --project=zettaneerpdq attachdisk --zone=us-central1-f --disk=aerodata01 aerovm01

# Restart Instance
gcutil --project=zettaneerpdq resetinstance aerovm01





